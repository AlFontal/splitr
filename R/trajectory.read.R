#' Read HYSPLIT trajectory output files
#' @description The function takes HYSPLIT trajectory output files in a specified output directory and processes all files into a data frame object.
#' @param archive the absolute path and filename of the trajectory archive file is to be provided.
#' @param year providing a year will filter the list of trajectory endpoints files to be read into a data frame. This is usually only effective for filtering those trajectory endpoints files generated by SplitR using the the 'hysplit.trajectory' function since such files have a specified naming convention.
#' @param start_height_m_AGL providing a starting height will filter the list of trajectory endpoints files to be read into a data frame. This argument can be used in conjunction with the 'year' argument in order to filter a directory of endpoints files by year and by starting height. As with the 'year' argument, this option is usually only effective for filtering those trajectory endpoints files generated by SplitR.
#' @return data frame with several wind trajectory parameters
#' @export trajectory.read
#' @examples
#' # Process all trajectory output files in the specified output directory
#' trajectory.df <- trajectory.read(archive =
#'                                  "~/hysplit/output/traj--2014-06-16--23-58-44.zip")
#' 
#' # Process trajectory output files in the same folder but only those
#' # files from 2002 with a starting height of 500 m
#' trajectory.df <- trajectory.read(archive =
#'                                    "~/hysplit/output/traj--2014-06-16--23-58-44.zip",
#'                                  year = 2002,
#'                                  start_height_m_AGL = 500)

trajectory.read <- function(archive,
                            year = NULL,
                            start_height_m_AGL = NULL){  
  
  # Generate the file list from the archive
  trajectory_file_dir <- tempdir()
    
  # Use UNIX system commands to unzip files to temporary directory
  if (.Platform$OS.type == "unix"){
    system(paste("cd '", gsub("(^.*/).*$", "\\1", path.expand(archive)), "' ; unzip -d '",
                 trajectory_file_dir, "' ",
                 gsub("^.*/(.*)$", "\\1", path.expand(archive)), sep = ''))
  }
  
  # Use Windows shell commands to unzip files to temporary directory
  if (.Platform$OS.type == "windows"){
    shell(paste("cd '", gsub("(^.*/).*$", "\\1", archive), "' ; unzip -d '",
                trajectory_file_dir, "' ",
                gsub("^.*/(.*)$", "\\1", archive), sep = ''))
  }
  
  trajectory_file_list <- list.files(trajectory_file_dir)
  
  # Optionally filter list of files by using 'year' or 'start_height_m_AGL' arguments,
  # or both
  if (is.null(year) & is.null(start_height_m_AGL)) {
    trajectory_file_list <- list.files(path = trajectory_file_dir,
                                       pattern = "^traj.*")
  } else if (!is.null(year) & is.null(start_height_m_AGL)) {
    trajectory_file_list <- list.files(path = trajectory_file_dirs,
                                       pattern = paste("^traj.*?)-",
                                                       gsub("^[0-9][0-9]", "",
                                                            as.character(year)),
                                                       ".*$", sep = ''))
  } else if (is.null(year) & !is.null(start_height_m_AGL)) {
    trajectory_file_list <- list.files(path = trajectory_file_dir,
                                       pattern = paste("^.*?height_",
                                                       gsub("^[0-9][0-9]", "",
                                                            as.character(year)),
                                                       ".*$", sep = ''))
  } else if (!is.null(year) & !is.null(start_height_m_AGL)) {
    trajectory_file_list <- list.files(path = trajectory_file_dir,
                                       pattern = paste("^traj.*?)-",
                                                       gsub("^[0-9][0-9]", "",
                                                            as.character(year)),
                                                       ".*?height_",
                                                       as.character(start_height_m_AGL),
                                                       "-.*$", sep = ''))
  }
  
  # Initialize empty data frame with 12 named columns
  traj.df <- setNames(data.frame(mat.or.vec(nr = 0, nc = 12)),
                      nm = c("receptor", "year", "month", "day",
                             "hour", "hour.inc", "lat", "lon", 
                             "height", "pressure", "date2", "date"))
  
  # Make loop with all trajectory files
  for (i in 1:length(trajectory_file_list)) {
    
    # For each trajectory file, read each line and determine where the variable-length
    # header ends
    column.widths <- c(92)
    traj_temp <- read.fwf(paste("file://", path.expand(path_output_files), "/",
                                trajectory_file_list[i], sep = ''),
                          widths = column.widths)
    
    for (j in 1:nrow(traj_temp)) {
      if(length(grep("PRESSURE", traj_temp[j,1])) != 0) skip_up_to_line <- j
    }
    
    column.widths <- c(6, 6, 6, 6, 6, 6, 6, 6,
                       8, 9, 9, 9, 9)
    
    traj <- read.fwf(paste("file://", path.expand(path_output_files), "/",
                           trajectory_file_list[i], sep = ''),
                     skip = skip_up_to_line,
                     widths = column.widths)
    names(traj) <- c("first", "receptor", "year", "month", "day", "hour", "zero1", "zero2", 
                     "hour.inc", "lat", "lon", "height", "pressure")
    traj$first <- NULL
    traj$zero1 <- NULL
    traj$zero2 <- NULL
    
    date2 <- mat.or.vec(nr = nrow(traj), nc = 1)
    for (k in 1:nrow(traj)) {
      date2[k] <- ISOdatetime(ifelse(traj[1,2] < 50, traj[1,2] + 2000, traj[1,2] + 1900),
                              traj[1,3], traj[1,4], traj[1,5], min = 0, sec = 0, tz = "GMT") +
        traj$hour.inc[k] * 3600}
    traj$date2 <- as.POSIXct(date2, origin = "1970-01-01", tz = "GMT")
    
    traj$date <- ISOdatetime(ifelse(traj[1,2] < 50, traj[1,2] + 2000, traj[1,2] + 1900),
                             traj[1,3], traj[1,4], traj[1,5], min = 0, sec = 0, tz = "GMT")
    
    # Continuously bind data frames together to make a large df with all trajectory files
    traj.df <- rbind(traj.df, traj)
    
    # Close the trajectory file loop  
  }
  
  return(traj.df)
  
}
